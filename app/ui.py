#FEYZ
#DEO
# -*- coding: utf-8 -*-
import sys
from pathlib import Path
from typing import List, Dict, Any
import streamlit as st

# -------------------------------------------------
# Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ app ØªÙˆÛŒ Streamlit Cloud Ù‡Ù… Ú©Ø§Ø± Ú©Ù†Ù‡
# -------------------------------------------------
PROJECT_ROOT = Path(__file__).resolve().parents[1]
if str(PROJECT_ROOT) not in sys.path:
    sys.path.insert(0, str(PROJECT_ROOT))

from app.generator import generate_answer
from app import retriever


# -------------------------------------------------
# ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØµÙØ­Ù‡
# -------------------------------------------------
st.set_page_config(
    page_title="Amin Mentor",
    page_icon="ğŸ’¬",
    layout="centered",
)

st.title("Amin Mentor")


# -------------------------------------------------
# State Ù…Ú©Ø§Ù„Ù…Ù‡
# Ù‡Ø± Ù¾ÛŒØ§Ù… ÛŒÚ© Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ Ù…Ø«Ù„ {"role": "user"|"assistant", "content": "..."}
# -------------------------------------------------
if "history" not in st.session_state:
    st.session_state.history: List[Dict[str, Any]] = []


def _append(role: str, content: str):
    """Ø§ÙØ²ÙˆØ¯Ù† Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø³Ø´Ù†"""
    st.session_state.history.append({"role": role, "content": content})


# -------------------------------------------------
# Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øª Ø±ÙˆÛŒ ØµÙØ­Ù‡ (Ø­Ø¨Ø§Ø¨ÛŒ)
# -------------------------------------------------
for turn in st.session_state.history:
    with st.chat_message("user" if turn["role"] == "user" else "assistant"):
        st.markdown(turn["content"])


#DEO
# -------------------------------------------------
# ÙØ±Ù… ÙˆØ±ÙˆØ¯ÛŒ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯
# -------------------------------------------------
with st.form("chat_form", clear_on_submit=True):
    user_msg = st.text_area(
        "Ù¾ÛŒØ§Ù…Øª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³:",
        height=120,
        placeholder="Ø³Ù„Ø§Ù…! Ù‡Ø± Ø³ÙˆØ§Ù„ÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø³ÛŒØ± Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±ØŒ ØªÙ…Ø±Ú©Ø²ØŒ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ Ú©Ø§Ø± ÛŒØ§ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø¯Ø§Ø±ÛŒ Ø§Ø² Ù…Ù† Ø¨Ù¾Ø±Ø³...",
    )
    submitted = st.form_submit_button("Ø¨ÙØ±Ø³Øª")


if submitted and user_msg.strip():
    user_text = user_msg.strip()

    # Û±. Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø± Ø§Ù„Ø§Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø¨Ø´Ù‡ Ú©Ù‡ ÙÙˆØ±ÛŒ ØªÙˆÛŒ UI Ù‡Ù… Ø¯ÛŒØ¯Ù‡ Ø¨Ø´Ù‡
    _append("user", user_text)

    # -------------------------------------------------
    # Û². Ø³Ø§Ø®Øª memory ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø¯Ù„
    # -------------------------------------------------
    # Ø§ÛŒÙ†Ø¬Ø§ Ù…Ø§ Ù„Ø§Ú¯ Ù…Ú©Ø§Ù„Ù…Ù‡ Ø±Ùˆ ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ù…Ø«Ù„ ÛŒÚ© Ú†Øª ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø¯Ù„ Ø¯Ø± Ù…ÛŒØ§Ø±ÛŒÙ…
    # ÛŒØ¹Ù†ÛŒ Ù…Ø¯Ù„ Ø¨Ø¯ÙˆÙ†Ù‡ "Ú†ÛŒ Ù¾Ø±Ø³ÛŒØ¯Ù‡ Ø´Ø¯" Ùˆ "Ú†ÛŒ Ø¬ÙˆØ§Ø¨ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯"
    # Ùˆ Ø§ÛŒÙ† Ø¨Ø§Ø¹Ø« Ù…ÛŒâ€ŒØ´Ù‡ ÙˆÙ‚ØªÛŒ Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒÚ¯Ù‡ "Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡" Ù…Ø¯Ù„ Ø¨Ø¯ÙˆÙ†Ù‡ Ø§Ø¯Ø§Ù…Ù‡Ù” Ú†ÛŒ.
    #
    # Ù…Ø­Ø¯ÙˆØ¯Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø¨Ù‡ Ø¢Ø®Ø±ÛŒÙ† ~8 Ù†ÙˆØ¨Øª Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ ØªÙˆÚ©Ù† Ù†Ø³ÙˆØ²ÙˆÙ†ÛŒÙ…
    # ÙØ±Ù…Øª Ú¯ÙØªâ€ŒÙˆÚ¯Ùˆ Ø±Ùˆ ÙˆØ§Ø¶Ø­ Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ…:
    # Ú©Ø§Ø±Ø¨Ø±: ...
    # Ù…Ù†ØªÙˆØ±: ...
    convo_lines: List[str] = []
    for turn in st.session_state.history[-8:]:
        if turn["role"] == "user":
            convo_lines.append(f"Ú©Ø§Ø±Ø¨Ø±: {turn['content']}")
        else:
            convo_lines.append(f"Ù…Ù†ØªÙˆØ±: {turn['content']}")
    conversation_block = "\n".join(convo_lines).strip()

    # -------------------------------------------------
    # Û³. Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¯Ø§Ù†Ø´ Ù…Ø±ØªØ¨Ø· (retriever)
    # -------------------------------------------------
    # Ø§ÛŒÙ† ÙÙ‚Ø· Ø¯Ø§Ù†Ø´ Ø¯Ø§Ù†Ø´ÛŒâ€ŒÙ‡ (Ø§Ø² Ù…ØªÙ†â€ŒÙ‡Ø§ Ùˆ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ Ùˆ Ú©ØªØ§Ø¨ Ùˆ ...)ØŒ
    # Ù†Ù‡ Ù„Ø§Ú¯ Ù…Ú©Ø§Ù„Ù…Ù‡. Ø§ÛŒÙ†Ùˆ Ù‡Ù… Ø¨Ù‡ Ù…Ø¯Ù„ Ù…ÛŒâ€ŒØ¯ÛŒÙ… ØªØ§ Ø¬ÙˆØ§Ø¨Ø´ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø¨Ø´Ù‡.
    knowledge_chunks: List[str] = []
    try:
        retrieved = retriever.retrieve(user_text, top_k=4)
        for r in retrieved[:4]:
            txt = r.get("text", "").strip()
            src = r.get("source", "")
            if txt:
                # Ù…Ù†Ø¨Ø¹ Ø±Ùˆ Ù†Ø±Ù… Ùˆ Ú©Ù…â€ŒØ­Ø§Ø´ÛŒÙ‡ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ… Ú©Ù‡ Ù…Ø¯Ù„ ÙÙ‚Ø· Ø§Ù„Ù‡Ø§Ù… Ø¨Ú¯ÛŒØ±Ù‡
                knowledge_chunks.append(f"{txt} (Ù…Ù†Ø¨Ø¹:{src})")
    except Exception:
        knowledge_chunks = []

    # Ø§ÛŒÙ† Ø¨Ù„Ø§Ú© Ø¯Ø§Ù†Ø´ÛŒ Ø±Ùˆ Ø¨Ù‡ ÛŒÚ© Ø±Ø´ØªÙ‡ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ù‡ Ø¨Ø¹Ø¯ Ø¨Ù‡ Ù…Ø¯Ù„ ØªØ²Ø±ÛŒÙ‚ Ø¨Ø´Ù‡
    # (Ø§Ú¯Ø± Ú†ÛŒØ²ÛŒ Ø¨Ø±Ú¯Ø´ØªÙ‡ Ø¨Ø§Ø´Ù‡)
    if knowledge_chunks:
        knowledge_block = "Ø¯Ø§Ù†Ø´ Ø¯Ø§Ø®Ù„ÛŒ Ù…Ø±ØªØ¨Ø·:\n" + "\n\n---\n\n".join(knowledge_chunks)
    else:
        knowledge_block = ""

    # -------------------------------------------------
    # Û´. Ø³Ø§Ø®Øª context Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ generate_answer
    # -------------------------------------------------
    # Ø­Ø§Ù„Ø§ Ø¨Ù‡ Ø¬Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø§ Ø®Ù„Ø§ØµÙ‡ Ù†ØµÙÙ‡ Ùˆ Ù†ÛŒÙ…Ù‡ØŒ
    # Ù…Ø§ Ø¯Ùˆ Ú†ÛŒØ² Ø±Ùˆ Ø¨Ù‡Ù… Ù…ÛŒâ€ŒÚ†Ø³Ø¨ÙˆÙ†ÛŒÙ…:
    # - history Ù…Ú©Ø§Ù„Ù…Ù‡ (conversation_block)
    # - Ø¯Ø§Ù†Ø´ Ø¯Ø§Ù…Ù†Ù‡â€ŒØ§ÛŒ (knowledge_block)
    #
    # Ø§ÛŒÙ† context Ø¯Ø± Ù†Ù‡Ø§ÛŒØª Ù…ÛŒØ±Ù‡ ØªÙˆÛŒ prompt Ù…Ø¯Ù„ Ø¯Ø§Ø®Ù„ generator.py
    # Ùˆ generator.py Ø¨Ø³ØªÙ‡ Ø¨Ù‡ Ø³Ø®ØªÛŒ Ø³ÙˆØ§Ù„ ØªØµÙ…ÛŒÙ… Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù‡ Ù…Ø¯Ù„ Ø§Ø±Ø²ÙˆÙ†â€ŒØªØ± ÛŒØ§ Ù‚ÙˆÛŒâ€ŒØªØ± Ø±Ùˆ ØµØ¯Ø§ Ø¨Ø²Ù†Ù‡.
    final_context_list: List[str] = []

    if knowledge_block:
        final_context_list.append(knowledge_block)

    if conversation_block:
        final_context_list.append(
            "Ú¯ÙØªÚ¯Ùˆ ØªØ§ Ø§ÛŒÙ† Ù„Ø­Ø¸Ù‡:\n" + conversation_block
        )

    # -------------------------------------------------
    # Ûµ. Ú¯Ø±ÙØªÙ† Ù¾Ø§Ø³Ø® Ø§Ø² Ù…Ø¯Ù„
    # -------------------------------------------------
    with st.spinner("Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù†..."):
        try:
            answer_text = generate_answer(
                query=user_text,
                context=final_context_list,
            )
        except Exception:
            # Ø§Ú¯Ø± Ù…Ø¯Ù„ Ù†Ù¾Ø±Ø³Ø¯/Ø´Ø¨Ú©Ù‡ Ù‚Ø·Ø¹ Ø´ÙˆØ¯ Ùˆ ...:
            answer_text = (
                "Ø§Ù„Ø§Ù† Ø§ØªØµØ§Ù„ Ù…Ù† Ø¨Ù‡ Ù…Ø¯Ù„ ÙÚ©Ø±ÛŒ Ù‚Ø·Ø¹ Ø´Ø¯. ÛŒÚ© Ø¨Ø§Ø± Ø¯ÛŒÚ¯Ù‡ Ø¨Ù¾Ø±Ø³ ÛŒØ§ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø¨Ú¯Ùˆ Ø§Ù„Ø§Ù† Ø¯Ù‚ÛŒÙ‚Ø§ Ø¯Ù†Ø¨Ø§Ù„ Ú†Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ù‡Ø³ØªÛŒ."
            )

    # -------------------------------------------------
    # Û¶. Ù†Ù…Ø§ÛŒØ´ Ùˆ Ø¢Ù¾Ø¯ÛŒØª ØªØ§Ø±ÛŒØ®Ú†Ù‡
    # -------------------------------------------------
    _append("assistant", answer_text)

    with st.chat_message("assistant"):
        st.markdown(answer_text)
