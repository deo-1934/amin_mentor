# app/ui.py
import sys
import os
import streamlit as st

# ------------------------------------------------------------
# Ù…Ø³ÛŒØ± Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ Ø¨Ù‡ sys.path Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø¯Ø± Cloud Ø§ÛŒÙ…Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§ Ø¨Ø´Ù†Ø§Ø³Ø¯
# ------------------------------------------------------------
CURRENT_DIR = os.path.dirname(os.path.abspath(__file__))
PROJECT_ROOT = os.path.abspath(os.path.join(CURRENT_DIR, ".."))
if PROJECT_ROOT not in sys.path:
    sys.path.insert(0, PROJECT_ROOT)

# ------------------------------------------------------------
# Ø§ÛŒÙ…Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø³ Ø¨Ø§ Ù„Ø§Ú¯ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯ Cloud
# ------------------------------------------------------------
try:
    from app.retriever import retrieve
except Exception as e:
    st.error(f"âŒ retriever import error: {e}")

try:
    from app.generator import generate_answer
except Exception as e:
    st.error(f"âŒ generator import error: {e}")

# ------------------------------------------------------------
# ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØµÙØ­Ù‡
# ------------------------------------------------------------
st.set_page_config(page_title="Amin Mentor", page_icon="ğŸ’¬")

st.title("ğŸ“ Amin Mentor")

st.markdown("""
Ø¨Ù‡ **Ù…Ù†ØªÙˆØ± Ø´Ø®ØµÛŒ Ø§Ù…ÛŒÙ†** Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ!  
Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ù¾Ø±Ø³Ø´â€ŒÙ‡Ø§Øª Ø¯Ø±Ø¨Ø§Ø±Ù‡â€ŒÛŒ Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±ØŒ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒØŒ Ùˆ ØªÙˆØ³Ø¹Ù‡ ÙØ±Ø¯ÛŒ Ø±Ùˆ Ø¨Ù¾Ø±Ø³ÛŒ ğŸ’¬  
Ùˆ Ø§Ø² Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù…Ù†ØªÙˆØ±ØŒ Ù¾Ø§Ø³Ø® ØªØ®ØµØµÛŒ Ùˆ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒâ€ŒØ´Ø¯Ù‡ Ø¨Ú¯ÛŒØ±ÛŒ.
""")

# ------------------------------------------------------------
# ÙˆØ±ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±
# ------------------------------------------------------------
query = st.text_input("Ø³Ø¤Ø§Ù„ Ø®ÙˆØ¯Øª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³ ğŸ‘‡")

if st.button("Ù¾Ø±Ø³ÛŒØ¯Ù† Ø§Ø² Ù…Ù†ØªÙˆØ± ğŸ§ ") and query:
    with st.spinner("Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾Ø§Ø³Ø® Ù…Ù†ØªÙˆØ±..."):
        try:
            # Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯Ù‡ Ø§Ø² Ø­Ø§ÙØ¸Ù‡ ÛŒØ§ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ù†Ø´
            retrieved_docs = retrieve(query)
            st.markdown("### ğŸ“š Ù…Ù†Ø§Ø¨Ø¹ Ù¾ÛŒØ¯Ø§ Ø´Ø¯Ù‡:")
            for i, doc in enumerate(retrieved_docs, start=1):
                st.markdown(f"**Ù…Ù†Ø¨Ø¹ {i}:** {doc}")

            # Ù¾Ø§Ø³Ø® Ù†Ù‡Ø§ÛŒÛŒ Ù…Ù†ØªÙˆØ±
            answer = generate_answer(query, retrieved_docs)
            st.markdown("### ğŸ’¬ Ù¾Ø§Ø³Ø® Ù…Ù†ØªÙˆØ±:")
            st.write(answer)

        except Exception as e:
            st.error(f"ğŸš¨ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯: {e}")
else:
    st.info("ğŸ‘† ÛŒÙ‡ Ø³Ø¤Ø§Ù„ Ø¨Ù†ÙˆÛŒØ³ Ùˆ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ù„Ø§ Ø¨Ø²Ù† ØªØ§ Ù¾Ø§Ø³Ø® Ù…Ù†ØªÙˆØ± Ø±Ùˆ Ø¨Ø¨ÛŒÙ†ÛŒ.")

# ------------------------------------------------------------
# Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙÙ†ÛŒ Ø¨Ø±Ø§ÛŒ ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
# ------------------------------------------------------------
with st.expander("âš™ï¸ Ø¬Ø²Ø¦ÛŒØ§Øª ÙÙ†ÛŒ (Ø¨Ø±Ø§ÛŒ ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡â€ŒÙ‡Ø§)"):
    st.json({
        "cwd": os.getcwd(),
        "sys.path": sys.path[:3],
        "file": __file__,
        "project_root": PROJECT_ROOT,
    })
