# app/generator.py
from typing import List, Dict, Any
import textwrap

def _build_answer(question: str, context_chunks: List[str]) -> str:
    """
    ÛŒÚ© Ù¾Ø§Ø³Ø® Ø´Ø¨Ù‡-Ù…Ù†ØªÙˆØ± Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ… Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³ÙˆØ§Ù„ Ùˆ ØªÚ©Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ† Ù¾ÛŒØ¯Ø§ Ø´Ø¯Ù‡.
    Ø§ÛŒÙ†Ø¬Ø§ Ø¹Ù…Ø¯Ø§Ù‹ Ù…Ø¯Ù„ Ø²Ø¨Ø§Ù†ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ ØµØ¯Ø§ Ø²Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ø¨Ø±Ø§ÛŒ Ø¯Ù…Ùˆ Ù¾Ø§ÛŒØ¯Ø§Ø± Ø¯Ø± Cloud).
    """

    # context_chunks: Ù„ÛŒØ³ØªÛŒ Ø§Ø² Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø·ÛŒ Ú©Ù‡ retriever Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ†Ø¯Ù‡
    merged_context = "\n".join(context_chunks[:3]) if context_chunks else ""

    # ÛŒÙ‡ ÙØ±Ù…Øª Ø¯ÙˆØ³ØªØ§Ù†Ù‡ØŒ Ø´Ø¨ÛŒÙ‡ Ù…Ù†ØªÙˆØ±
    answer = f"""
    Ø³ÙˆØ§Ù„ ØªÙˆ: {question}

    Ú†ÛŒØ²ÛŒ Ú©Ù‡ Ø§Ø² Ù…Ù†Ø§Ø¨Ø¹ Ù…ØªÙ†ÛŒ Ù…Ø±ØªØ¨Ø· ÙÙ‡Ù…ÛŒØ¯Ù…:
    {merged_context}

    Ù†Ú©ØªÙ‡ Ù…Ù†ØªÙˆØ±:
    - Ø§ÙˆÙ„ Ø±ÙˆÛŒ Ø¯Ø±Ú© Ù…ÙˆÙ‚Ø¹ÛŒØª Ùˆ Ù†ÛŒØ§Ø² Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ ØªÙ…Ø±Ú©Ø² Ú©Ù†.
    - Ø¨Ø¹Ø¯ Ø³Ø¹ÛŒ Ú©Ù† Ú©Ø§Ø±ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø´Ù‡ Ø±Ùˆ ÙˆØ§Ø¶Ø­ Ùˆ Ø¨Ø¯ÙˆÙ† Ø­Ø§Ø´ÛŒÙ‡ Ø¨Ú¯ÛŒ.
    - Ùˆ Ù‡Ù…ÛŒØ´Ù‡ ÛŒÚ© Ù‚Ø¯Ù… Ø¹Ù…Ù„ÛŒ Ù…Ø´Ø®Øµ Ø¨Ø±Ø§ÛŒ Ø¨Ø¹Ø¯ ØªØ¹Ø±ÛŒÙ Ú©Ù† (Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ¯ØªØŒ Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„).

    Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø¨ÛŒØ´ØªØ± Ø¨Ø§Ø²Ø´ Ú©Ù†Ù…ØŒ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø³ÙˆØ§Ù„Øª Ø±Ùˆ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ùˆ Ø¨Ø§ Ù…Ø«Ø§Ù„ Ø¨Ù¾Ø±Ø³ÛŒ (Ù…Ø«Ù„Ø§Ù‹: Â«Ù…Ù† Ø¨Ø§ Ù…Ø¯ÛŒØ±Ù… Ù…Ø°Ø§Ú©Ø±Ù‡ Ø¯Ø§Ø±Ù… Ø³Ø± Ø§ÙØ²Ø§ÛŒØ´ Ø­Ù‚ÙˆÙ‚ØŒ Ú†ÛŒ Ø¨Ú¯Ù…ØŸÂ»).
    """.strip()

    # Ù‚Ø´Ù†Ú¯â€ŒØªØ±Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ÛŒÚ©Ù…
    return textwrap.dedent(answer)

def generate_answer(question: str, context_chunks: List[str]) -> str:
    """
    API Ø§ØµÙ„ÛŒ Ú©Ù‡ ui.py ØµØ¯Ø§ Ù…ÛŒâ€ŒØ²Ù†Ø¯.
    """
    # Ø§Ú¯Ø± ÙˆØ±ÙˆØ¯ÛŒ Ø®Ø§Ù„ÛŒÙ‡
    if not question or not isinstance(question, str):
        return "Ø³Ø¤Ø§Ù„Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø±Ù‡. Ù„Ø·ÙØ§Ù‹ ÛŒÙ‡ Ø³Ø¤Ø§Ù„ Ù…Ø¹Ù†ÛŒâ€ŒØ¯Ø§Ø± Ø¨Ù¾Ø±Ø³ ðŸ™‚"

    # Ø§Ú¯Ù‡ Ø¨Ù‡ Ù‡Ø± Ø¯Ù„ÛŒÙ„ context_chunks None ÛŒØ§ Ú†ÛŒØ² Ø¹Ø¬ÛŒØ¨Ù‡
    if not isinstance(context_chunks, list):
        context_chunks = []

    return _build_answer(question, context_chunks)

def healthcheck() -> Dict[str, Any]:
    """
    Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯ (Ø§Ù„Ø§Ù† Ø®ÛŒÙ„ÛŒ Ø³Ø§Ø¯Ù‡ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ…)
    """
    return {
        "provider": "local-demo",
        "huggingface_used": False,
        "ok": True,
    }
