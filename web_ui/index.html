<!--
#FEYZ
#DEO
-->

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Ù…Ù†ØªÙˆØ± Ø´Ø®ØµÛŒ Ø§Ù…ÛŒÙ† ğŸ¤–</title>

  <style>
    :root {
      --text-main: #e2e8f0;
      --text-dim: #94a3b8;
      --accent: #38bdf8;

      --panel-bg: rgba(15,23,42,0.4);
      --panel-border: rgba(148,163,184,0.18);
      --panel-blur: blur(16px);

      --bubble-user-bg: rgba(37, 58, 91, 0.6);
      --bubble-user-border: rgba(148,163,184,0.28);

      --bubble-bot-bg: rgba(15,23,42,0.55);
      --bubble-bot-border: rgba(148,163,184,0.18);

      --radius-lg: 16px;
      --radius-xl: 18px;
      --radius-full: 999px;

      --font-main: system-ui, -apple-system, BlinkMacSystemFont,
        "IRANSans", "Inter", Roboto, "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      color: var(--text-main);
      font-family: var(--font-main);
      background: #0b1120; /* fallback Ø¯Ø± ØµÙˆØ±Øª Ø¨Ø§Ú¯ Ø±Ù†Ø¯Ø± */
      overflow-x: hidden;
    }

    /* =========================
       ğŸ”¥ AURORA 2.0 - Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ù…ØªØ­Ø±Ú© ÙˆØ§Ù‚Ø¹ÛŒ
       Ø¯Ùˆ Ù„Ø§ÛŒÙ‡ Ù†ÙˆØ± + Ø­Ø±Ú©Øª + ØªØºÛŒÛŒØ± ØªØ¯Ø±ÛŒØ¬ÛŒ Ø±Ù†Ú¯
       ========================= */

    /* Ù„Ø§ÛŒÙ‡â€Œ Ø§ÙˆÙ„: ØªÙˆØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ø±Ù… Ùˆ Ø¨Ø²Ø±Ú¯ Ø´ÙÙ‚ */
    .aurora-bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      background:
        radial-gradient(circle at 20% 20%, rgba(16,185,129,0.4) 0%, rgba(0,0,0,0) 60%),
        radial-gradient(circle at 80% 30%, rgba(59,130,246,0.45) 0%, rgba(0,0,0,0) 60%),
        radial-gradient(circle at 50% 80%, rgba(147,51,234,0.4) 0%, rgba(0,0,0,0) 60%);
      background-blend-mode: screen;
      filter: blur(80px);
      opacity: 0.55;
      animation: auroraMove 28s ease-in-out infinite;
      pointer-events: none;
    }

    /* Ù„Ø§ÛŒÙ‡ Ø¯ÙˆÙ…: Ø±Ú¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø´ÛŒØ¯Ù‡â€ŒÛŒ Ù†ÙˆØ±ØŒ Ø¨Ø§ ØªØºÛŒÛŒØ± Ø±Ù†Ú¯ Ø¯Ø± Ø·ÙˆÙ„ Ø²Ù…Ø§Ù† */
    .aurora-glow {
      position: fixed;
      inset: 0;
      z-index: 0;
      background: linear-gradient(
        120deg,
        rgba(59,130,246,0.35) 0%,
        rgba(16,185,129,0.3) 25%,
        rgba(147,51,234,0.35) 50%,
        rgba(16,185,129,0.3) 75%,
        rgba(59,130,246,0.35) 100%
      );
      background-size: 300% 300%;
      mix-blend-mode: screen;
      filter: blur(120px);
      opacity: 0.5;
      animation: gradientFlow 18s ease-in-out infinite;
      pointer-events: none;
    }

    /* Ù„Ø§ÛŒÙ‡ Ø³ÙˆÙ…: ÛŒÙ‡ Ø³Ø§ÛŒÙ‡ Ù…Ù„Ø§ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø§ÛŒÛŒ Ù…ØªÙ† */
    .dim-overlay {
      position: fixed;
      inset: 0;
      z-index: 1;
      background: radial-gradient(
        circle at 50% 20%,
        rgba(0,0,0,0) 0%,
        rgba(0,0,0,0.7) 60%
      );
      pointer-events: none;
    }

    /* Ø­Ø±Ú©Øª Ø¢Ø±Ø§Ù… Ùˆ ØªÙ†ÙØ³ÛŒ ØªÙˆØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø´ÙÙ‚ */
    @keyframes auroraMove {
      0%   { transform: translate3d(0,0,0) scale(1); }
      25%  { transform: translate3d(-8%, -4%, 0) scale(1.1); }
      50%  { transform: translate3d(10%, 6%, 0) scale(1.22); }
      75%  { transform: translate3d(-4%, 4%, 0) scale(1.1); }
      100% { transform: translate3d(0,0,0) scale(1); }
    }

    /* Ø´ÙØª Ù¾Ø§Ù„Øª Ø±Ù†Ú¯ Ùˆ Ø§Ø³Ù„Ø§ÛŒØ¯ Ù‡Ø§Ù„Ù‡â€ŒÛŒ Ù†ÙˆØ± */
    @keyframes gradientFlow {
      0% {
        background-position: 0% 50%;
        filter: blur(120px) hue-rotate(0deg);
      }
      25% {
        background-position: 50% 30%;
        filter: blur(130px) hue-rotate(40deg);
      }
      50% {
        background-position: 100% 50%;
        filter: blur(140px) hue-rotate(80deg);
      }
      75% {
        background-position: 50% 70%;
        filter: blur(130px) hue-rotate(40deg);
      }
      100% {
        background-position: 0% 50%;
        filter: blur(120px) hue-rotate(0deg);
      }
    }

    /* =========================
       Ù„Ø§ÛŒÙ‡ Ù…Ø­ØªÙˆØ§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ
       ========================= */

    .page-wrapper {
      position: relative;
      z-index: 2; /* Ø¨Ø§Ù„Ø§ÛŒ aurora Ùˆ dim-overlay */
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 16px 160px; /* Ø¬Ø§ Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ§Ø± ÙˆØ±ÙˆØ¯ÛŒ Ù¾Ø§ÛŒÛŒÙ† */
    }

    /* INTRO / HEADER */
    .intro-block {
      max-width: 640px;
      width: 100%;
      text-align: center;
      margin-bottom: 24px;
    }

    .intro-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      line-height: 1.5;
    }

    .status-pill {
      font-size: .65rem;
      font-weight: 500;
      color: #10b981;
      background: rgba(16,185,129,0.12);
      border: 1px solid rgba(16,185,129,0.4);
      border-radius: var(--radius-full);
      padding: 2px 8px;
      line-height: 1.4;
      margin-top: 4px;
    }

    .intro-card {
      display: inline-block;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: var(--radius-lg);
      backdrop-filter: var(--panel-blur);
      -webkit-backdrop-filter: var(--panel-blur);
      padding: 16px 20px;
      text-align: right;
      font-size: .9rem;
      line-height: 1.6;
      color: var(--text-main);
      box-shadow: 0 30px 80px rgba(0,0,0,0.8);
    }

    .intro-mainline {
      margin-bottom: 8px;
      font-weight: 500;
      font-size: .9rem;
      color: var(--text-main);
      line-height: 1.5;
    }

    .disclaimer {
      font-size: .75rem;
      color: var(--text-dim);
      line-height: 1.5;
      border-right: 2px solid rgba(148,163,184,0.25);
      padding-right: 10px;
      text-align: right;
    }

    /* CHAT AREA */
    .chat-box {
      width: 100%;
      max-width: 700px;
      min-height: 220px;
      max-height: 50vh;
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148,163,184,0.15);
      background: rgba(10,15,26,0.4);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow:
        inset 0 0 40px rgba(0,0,0,0.8),
        0 30px 80px rgba(0,0,0,0.8);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .msg-wrapper {
      display: flex;
      max-width: 85%;
      filter: drop-shadow(0 20px 30px rgba(0,0,0,0.8));
    }

    .from-user {
      align-self: flex-end;
      flex-direction: column;
      text-align: right;
    }

    .from-bot {
      align-self: flex-start;
      flex-direction: column;
      text-align: right;
    }

    .bubble {
      border-radius: var(--radius-xl);
      padding: 12px 14px;
      font-size: .9rem;
      line-height: 1.6;
      color: var(--text-main);
      white-space: pre-wrap;
      word-break: break-word;
      border: 1px solid transparent;
      box-shadow:
        0 16px 40px rgba(0,0,0,0.8),
        0 0 60px rgba(56,189,248,0.08);
    }

    .bubble.user {
      background: var(--bubble-user-bg);
      border: 1px solid var(--bubble-user-border);
    }

    .bubble.bot {
      background: var(--bubble-bot-bg);
      border: 1px solid var(--bubble-bot-border);
    }

    .bot-name {
      font-size: .7rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .meta-line {
      font-size: .65rem;
      color: var(--text-dim);
      margin-top: 6px;
      line-height: 1.4;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
    }

    .ctx-chip {
      background: rgba(15,23,42,0.6);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: var(--radius-full);
      padding: 2px 8px;
      font-size: .6rem;
      font-weight: 500;
      line-height: 1.4;
      white-space: nowrap;
      color: var(--text-main);
    }

    .typing-bubble {
      background: rgba(15,23,42,0.4);
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: var(--radius-xl);
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: .75rem;
      color: var(--text-dim);
      width: fit-content;
    }

    .dot {
      width: 6px; height: 6px;
      border-radius: 999px;
      background: var(--accent);
      animation: blink 1s infinite;
    }

    .dot:nth-child(2) { animation-delay: .2s; }
    .dot:nth-child(3) { animation-delay: .4s; }

    @keyframes blink {
      0%,100% {opacity:.2;}
      50% {opacity:1;}
    }

    /* =========================
       Ù†ÙˆØ§Ø± ÙˆØ±ÙˆØ¯ÛŒ Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡
       ========================= */
    .input-area {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 3; /* Ø±ÙˆÛŒ aurora Ùˆ ØµÙØ­Ù‡ */
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px;
    }

    .input-shell {
      width: 100%;
      max-width: 700px;
      background: rgba(15,23,42,0.5);
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: var(--radius-xl);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow:
        0 30px 80px rgba(0,0,0,0.8),
        0 0 60px rgba(56,189,248,0.4);
      padding: 12px 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      min-width: 200px;
      min-height: 48px;
      max-height: 120px;
      background: transparent;
      border: none;
      color: var(--text-main);
      font-family: inherit;
      font-size: .9rem;
      line-height: 1.5;
      outline: none;
      resize: none;
    }

    .send-btn {
      background: var(--accent);
      color: #0a0f1a;
      border: 0;
      border-radius: var(--radius-full);
      font-size: .8rem;
      font-weight: 600;
      padding: 10px 16px;
      line-height: 1.2;
      cursor: pointer;
      box-shadow:
        0 20px 40px rgba(56,189,248,0.4),
        0 0 60px rgba(56,189,248,0.5);
      min-width: 80px;
      align-self: flex-end;
    }

    .hint-row {
      width: 100%;
      max-width: 700px;
      color: var(--text-dim);
      font-size: .7rem;
      line-height: 1.4;
      padding-top: 8px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      text-shadow: 0 2px 6px rgba(0,0,0,0.9);
    }

    /* =========================
       Ø¯Ú©Ù…Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ + Ù¾Ù†Ù„
       ========================= */
    .settings-btn {
      position: fixed;
      bottom: 90px;
      left: 16px;
      z-index: 4; /* Ø±ÙˆÛŒ input-area */
      background: rgba(15,23,42,0.5);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: var(--radius-full);
      color: var(--text-main);
      width: 36px;
      height: 36px;
      font-size: .8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      line-height: 1;
      box-shadow:
        0 20px 40px rgba(0,0,0,0.8),
        0 0 60px rgba(56,189,248,0.4);
    }

    .drawer {
      position: fixed;
      bottom: 140px;
      left: 16px;
      z-index: 5; /* Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† */
      width: 240px;
      max-width: 90%;
      background: rgba(15,23,42,0.78);
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: var(--radius-lg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: 0 30px 80px rgba(0,0,0,0.9);
      padding: 16px;
      display: none;
      flex-direction: column;
      gap: 16px;
      color: var(--text-main);
    }

    .drawer-head {
      font-size: .8rem;
      font-weight: 600;
      color: var(--text-main);
      line-height: 1.4;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4px;
    }

    .drawer-close {
      background: rgba(15,23,42,0.6);
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: var(--radius-full);
      color: var(--text-main);
      width: 26px;
      height: 26px;
      font-size: .7rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      line-height: 1;
    }

    .drawer-sub {
      color: var(--text-dim);
      font-size: .7rem;
      line-height: 1.4;
      margin-bottom: 12px;
    }

    .drawer-field {
      margin-bottom: 12px;
    }

    .drawer-field label {
      font-size: .7rem;
      color: var(--text-dim);
      margin-bottom: 4px;
      display: block;
    }

    .drawer-field .row-inline {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: .7rem;
      color: var(--text-main);
    }

    .drawer-field input[type="range"],
    .drawer-field select {
      width: 100%;
      background: rgba(15,23,42,0.6);
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: var(--radius-lg);
      color: var(--text-main);
      padding: 6px 8px;
      font-family: inherit;
      font-size: .8rem;
    }

    .regen-btn {
      background: rgba(15,23,42,0.5);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: var(--radius-full);
      color: var(--text-main);
      font-size: .7rem;
      padding: 6px 10px;
      cursor: pointer;
      line-height: 1.2;
      text-align: center;
      width: 100%;
    }

    .regen-hint {
      font-size: .7rem;
      color: var(--text-dim);
      line-height: 1.4;
      margin-top: 6px;
      text-align: right;
    }

    /* toast Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ú©ÙˆØªØ§Ù‡ */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 140px;
      z-index: 9999;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(56,189,248,0.5);
      color: var(--text-main);
      border-radius: var(--radius-full);
      padding: 8px 14px;
      font-size: .75rem;
      line-height: 1.3;
      box-shadow:
        0 30px 80px rgba(0,0,0,0.9),
        0 0 120px rgba(56,189,248,0.4);
      opacity: 0;
      transition: opacity .4s;
      pointer-events: none;
      white-space: nowrap;
    }

    .toast.show { opacity: 1; }

    @media (max-width: 480px) {
      .intro-card { font-size: .8rem; }
      .disclaimer { font-size: .7rem; }
      .chat-box { max-height: 45vh; }
      .send-btn { min-width: 72px; font-size: .75rem; }
      .hint-row { font-size: .65rem; }
    }
  </style>
</head>
<body>

<!-- Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø´ÙÙ‚ -->
<div class="aurora-bg"></div>
<div class="aurora-glow"></div>
<div class="dim-overlay"></div>

<!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ -->
<div class="page-wrapper">

  <!-- Ù…Ø¹Ø±ÙÛŒ/Ù‡Ø¯Ø± -->
  <div class="intro-block">
    <div class="intro-title">
      <div>Ù…Ù†ØªÙˆØ± Ø´Ø®ØµÛŒ Ø§Ù…ÛŒÙ† ğŸ¤–</div>
      <div class="status-pill">online</div>
    </div>

    <div class="intro-card">
      <div class="intro-mainline">
        Ø³Ù„Ø§Ù…. Ù…Ù† Ù…Ù†ØªÙˆØ± Ø´Ø®ØµÛŒ Ø§Ù…ÛŒÙ† Ù‡Ø³ØªÙ…. Ø§Ù„Ø§Ù† Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† Ø¯Ø±Ø¯Ø³Ø±Øª ØªÙˆÛŒ Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±Øª Ú†ÛŒÙ‡ØŸ
      </div>
      <div class="disclaimer">
        Ù…Ù† Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù… Ø±Ø§Ù‡â€ŒØ­Ù„ ÙˆØ§Ù‚Ø¹ÛŒ Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒØ¨Ù‡â€ŒÙ…Ø±Ø­Ù„Ù‡ Ø¨Ø¯Ù….
        Ø§Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ø¯ÙˆÙ†ÛŒ Ù…Ù† ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒÙ… Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§ØªÙ… ØµØ±ÙØ§Ù‹ Ø¬Ù†Ø¨Ù‡Ù” Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø¯Ø§Ø±Ù†
        Ùˆ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…Ø´Ø§ÙˆØ± Ø­Ù‚ÙˆÙ‚ÛŒØŒ Ù…Ø§Ù„ÛŒ ÛŒØ§ ÙˆÚ©ÛŒÙ„ Ø±Ø³Ù…ÛŒ Ù†ÛŒØ³ØªÙ….
      </div>
    </div>
  </div>

  <!-- ÙØ¶Ø§ÛŒ Ú†Øª (Ø´Ø±ÙˆØ¹ Ø®Ø§Ù„ÛŒ) -->
  <div id="chatBox" class="chat-box"></div>

</div>

<!-- Ù†ÙˆØ§Ø± ÙˆØ±ÙˆØ¯ÛŒ Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ -->
<div class="input-area">
  <div class="input-shell">
    <textarea
      id="chatInput"
      class="chat-input"
      placeholder="Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù† Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ú†Ù‡ Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø§Ø±ÛŒØŸ Ù…Ø«Ù„Ø§: Ù…Ù† Ù…Ø­ØµÙˆÙ„ Ø¯Ø§Ø±Ù… ÙˆÙ„ÛŒ Ù‡ÛŒÚ† ÙØ±ÙˆØ´ÛŒ Ù†Ø¯Ø§Ø±Ù…."></textarea>

    <button id="sendBtn" class="send-btn">Ø§Ø±Ø³Ø§Ù„</button>
  </div>

  <div class="hint-row">
    <span>Ù…Ù† Ø§ÙˆÙ„ ÛŒÚ© Ø¬ÙˆØ§Ø¨ Ù…ÛŒâ€ŒÙ†ÙˆÛŒØ³Ù… âœï¸ Ø¨Ø¹Ø¯ Ù‡Ù…ÙˆÙ†Ùˆ Ø¨Ø§ Ù…Ù†Ø§Ø¨Ø¹ Ø®ÙˆØ¯Øª Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù… ğŸ”</span>
    <span>Ù‡Ø¯Ù: ÛŒÚ© Ù‚Ø¯Ù… Ø¹Ù…Ù„ÛŒ Ø¨Ø¹Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ ØªÙˆ âœ…</span>
  </div>
</div>

<!-- Ø¯Ú©Ù…Ù‡ âš™ï¸ Ùˆ Ù¾Ù†Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
<div class="settings-btn" id="settingsBtn" title="ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡">âš™ï¸</div>

<div class="drawer" id="drawer">
  <div class="drawer-head">
    <div style="font-size:.8rem;font-weight:600;color:var(--text-main);line-height:1.4;">
      ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø§Ø³Ø®
    </div>
    <div class="drawer-close" id="drawerCloseBtn">âœ•</div>
  </div>

  <div class="drawer-sub">
    Ø®Ù„Ø§Ù‚ÛŒØª Ø¨Ø§Ù„Ø§ØªØ± = Ù„Ø­Ù† ØµÙ…ÛŒÙ…ÛŒâ€ŒØªØ± Ùˆ Ù…Ø«Ø§Ù„ Ø¨ÛŒØ´ØªØ±.
    Ø®Ù„Ø§Ù‚ÛŒØª Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± = Ø±Ø³Ù…ÛŒâ€ŒØªØ± Ùˆ Ù…Ø³ØªÙ‚ÛŒÙ…â€ŒØªØ±.
  </div>

  <div class="drawer-field">
    <label for="creativeLevel">Ø®Ù„Ø§Ù‚ÛŒØª Ù¾Ø§Ø³Ø®</label>
    <div class="row-inline">
      <input type="range" id="creativeLevel" min="1" max="5" value="2" />
      <span style="font-size:.7rem;color:var(--text-main);">
        <span id="creativeVal">2</span>/5
      </span>
    </div>
  </div>

  <div class="drawer-field">
    <label for="maxTokensSelect">Ø­Ø¯Ø§Ú©Ø«Ø± Ø·ÙˆÙ„ Ù¾Ø§Ø³Ø®</label>
    <select id="maxTokensSelect">
      <option value="256">Ú©ÙˆØªØ§Ù‡ Ùˆ Ø¬Ù…Ø¹â€ŒÙˆØ¬ÙˆØ±</option>
      <option value="512" selected>Ù…ØªÙˆØ³Ø· Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ</option>
      <option value="768">ØªÙˆØ¶ÛŒØ­ Ú©Ø§Ù…Ù„</option>
      <option value="1024">Ø®ÛŒÙ„ÛŒ Ù…ÙØµÙ„</option>
    </select>
  </div>

  <div class="drawer-field">
    <button class="regen-btn" id="regenBtn">ğŸ” Ø¨Ø§Ø²ØªÙˆÙ„ÛŒØ¯ Ù¾Ø§Ø³Ø® Ø¢Ø®Ø±</button>
    <div class="regen-hint">
      Ù‡Ù…ÙˆÙ† Ø³ÙˆØ§Ù„ØŒ Ø¨Ø§ Ø®Ø±ÙˆØ¬ÛŒ Ø¬Ø¯ÛŒØ¯.
    </div>
  </div>

  <div class="drawer-field">
    <button class="regen-btn" id="copyBtn">ğŸ“‹ Ú©Ù¾ÛŒ Ù¾Ø§Ø³Ø® Ø¢Ø®Ø±</button>
  </div>

  <div class="drawer-field">
    <button class="regen-btn" id="exportBtn">ğŸ’¾ Ø®Ø±ÙˆØ¬ÛŒ Ú†Øª</button>
  </div>

  <div class="drawer-field">
    <button class="regen-btn" id="clearChatBtn" style="color:#ef4444;border-color:#ef4444;">
      ğŸ§¹ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ù…Ú©Ø§Ù„Ù…Ù‡
    </button>
  </div>
</div>

<div id="toast" class="toast"></div>

<!--
#FEYZ
#DEO
-->

<script>
  // refs
  const chatBox = document.getElementById("chatBox");
  const chatInput = document.getElementById("chatInput");
  const sendBtn = document.getElementById("sendBtn");

  const settingsBtn = document.getElementById("settingsBtn");
  const drawer = document.getElementById("drawer");
  const drawerCloseBtn = document.getElementById("drawerCloseBtn");

  const creativeLevelEl = document.getElementById("creativeLevel");
  const creativeValEl = document.getElementById("creativeVal");
  const maxTokensSelect = document.getElementById("maxTokensSelect");

  const regenBtn = document.getElementById("regenBtn");
  const copyBtn = document.getElementById("copyBtn");
  const exportBtn = document.getElementById("exportBtn");
  const clearChatBtn = document.getElementById("clearChatBtn");

  const toastEl = document.getElementById("toast");

  // Ù…Ú©Ø§Ù„Ù…Ù‡ Ø±ÙˆÛŒ ÙØ±Ø§Ù†Øª
  // Ù‡Ø± Ø¢ÛŒØªÙ…: { role: "user"|"assistant", content:"...", meta? }
  let history = [];
  let lastAssistantRaw = "";

  // Ø¢Ø¯Ø±Ø³ Ø¨Ú©â€ŒØ§Ù†Ø¯ FastAPI
  const API_URL = "http://localhost:8000/chat";

  // helpers
  function scrollToBottom() {
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function sanitize(html) {
    const div = document.createElement("div");
    div.textContent = html;
    return div.innerHTML.replace(/\n/g, "<br>");
  }

  function appendUserMessage(text) {
    const wrap = document.createElement("div");
    wrap.className = "msg-wrapper from-user";

    const bubble = document.createElement("div");
    bubble.className = "bubble user";
    bubble.innerHTML = sanitize(text);

    wrap.appendChild(bubble);
    chatBox.appendChild(wrap);

    history.push({ role: "user", content: text });
    scrollToBottom();
  }

  function appendBotMessage(answerText, tookMs, contextsArray) {
    const wrap = document.createElement("div");
    wrap.className = "msg-wrapper from-bot";

    const bubble = document.createElement("div");
    bubble.className = "bubble bot";

    const name = document.createElement("div");
    name.className = "bot-name";
    name.textContent = "Ù…Ù†ØªÙˆØ± Ø´Ø®ØµÛŒ Ø§Ù…ÛŒÙ† âœ³ï¸";
    bubble.appendChild(name);

    const body = document.createElement("div");
    body.innerHTML = sanitize(answerText);
    bubble.appendChild(body);

    wrap.appendChild(bubble);

    const meta = document.createElement("div");
    meta.className = "meta-line";

    if (tookMs !== null && tookMs !== undefined) {
      const t = document.createElement("span");
      t.textContent = `â± ${Math.round(tookMs)} ms`;
      meta.appendChild(t);
    }

    (contextsArray || []).forEach(ctx => {
      const chip = document.createElement("span");
      chip.className = "ctx-chip";
      const dist = typeof ctx.distance === "number"
        ? ctx.distance.toFixed(3)
        : (ctx.distance ?? "");
      chip.textContent = `Ù…Ù†Ø¨Ø¹ #${ctx.id ?? "?"} Â· ${dist}`;
      meta.appendChild(chip);
    });

    wrap.appendChild(meta);

    chatBox.appendChild(wrap);

    history.push({
      role: "assistant",
      content: answerText,
      meta: { took_ms: tookMs || 0, contexts: contextsArray || [] }
    });

    lastAssistantRaw = answerText;
    scrollToBottom();
  }

  function appendTypingIndicator() {
    const wrap = document.createElement("div");
    wrap.className = "msg-wrapper from-bot";
    wrap.id = "typingIndicator";

    const bubble = document.createElement("div");
    bubble.className = "typing-bubble";
    bubble.innerHTML = `
      <span>Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù†...</span>
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    `;

    wrap.appendChild(bubble);
    chatBox.appendChild(wrap);
    scrollToBottom();
  }

  function removeTypingIndicator() {
    const el = document.getElementById("typingIndicator");
    if (el) el.remove();
  }

  function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(() => {
      toastEl.classList.remove("show");
    }, 1500);
  }

  async function askMentor(userText, {creative, maxTokens}, isRegen=false) {
    appendTypingIndicator();

    const payload = {
      message: userText,
      creative_level: Number(creative),
      max_new_tokens: Number(maxTokens)
    };

    const t0 = performance.now();
    let tookMs = null;

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      const t1 = performance.now();
      tookMs = t1 - t0;

      removeTypingIndicator();

      const answerText = data.answer ?? "[Ù¾Ø§Ø³Ø®ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯]";
      const ctxs = data.contexts ?? [];
      const dur = data.took_ms ?? tookMs;

      appendBotMessage(answerText, dur, ctxs);
    } catch (err) {
      console.error("API error:", err);
      removeTypingIndicator();
      appendBotMessage(
        "Ø§Ù„Ø§Ù† Ø¨Ù‡ Ù…Ø¯Ù„ ÙˆØµÙ„ Ù†ÛŒØ³ØªÙ…. ÛŒÚ©Ù… Ø¨Ø¹Ø¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ù¾Ø±Ø³ ğŸŒ± Ø³ÙˆØ§Ù„Øª Ø±Ùˆ Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ….",
        null,
        []
      );
    }
  }

  function handleSend(textOverride=null) {
    const text = textOverride ?? chatInput.value.trim();
    if (!text) return;

    appendUserMessage(text);
    chatInput.value = "";

    askMentor(text, {
      creative: creativeLevelEl.value,
      maxTokens: maxTokensSelect.value
    });
  }

  sendBtn.addEventListener("click", () => handleSend());
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });

  settingsBtn.addEventListener("click", () => {
    drawer.style.display = "flex";
  });

  drawerCloseBtn.addEventListener("click", () => {
    drawer.style.display = "none";
  });

  creativeLevelEl.addEventListener("input", () => {
    creativeValEl.textContent = creativeLevelEl.value;
  });

  regenBtn.addEventListener("click", () => {
    const lastUser = [...history].reverse().find(m => m.role === "user");
    if (!lastUser) {
      showToast("Ø³ÙˆØ§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ØªÙˆÙ„ÛŒØ¯ Ù†Ø¯Ø§Ø±ÛŒÙ… ğŸ˜…");
      return;
    }
    askMentor(lastUser.content, {
      creative: creativeLevelEl.value,
      maxTokens: maxTokensSelect.value
    }, true);
  });

  copyBtn.addEventListener("click", async () => {
    if (!lastAssistantRaw) {
      showToast("Ù‡Ù†ÙˆØ² Ù¾Ø§Ø³Ø®ÛŒ Ù†Ø¯Ø§Ø±ÛŒÙ… ğŸ˜…");
      return;
    }
    try {
      await navigator.clipboard.writeText(lastAssistantRaw);
      showToast("Ú©Ù¾ÛŒ Ø´Ø¯ âœ…");
    } catch {
      showToast("Ú©Ù¾ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚ â—");
    }
  });

  exportBtn.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(history, null, 2)], {
      type: "application/json;charset=utf-8"
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.download = "chat_export.json";
    a.href = url;
    a.click();
    URL.revokeObjectURL(url);
    showToast("ÙØ§ÛŒÙ„ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯ ğŸ’¾");
  });

  clearChatBtn.addEventListener("click", () => {
    history = [];
    lastAssistantRaw = "";
    chatBox.innerHTML = "";
    showToast("Ù¾Ø§Ú© Ø´Ø¯ âœ¨");
  });

  scrollToBottom();
</script>

</body>
</html>
